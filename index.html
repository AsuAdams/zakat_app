<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=yes, viewport-fit=cover" />
<title>Zakat Manager - MKA Uganda</title>
<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
  }

  :root{
    --bg:#0f3b2c;
    --accent:#f4b400;
    --card-bg:#ffffff;
    --card-text:#0f3b2c;
    --muted:#6b6b6b;
    --header-bg: #0f3b2c;
    --scrollbar-track: #f1f1f1;
    --scrollbar-thumb: #0f3b2c;
    --scrollbar-thumb-hover: #1a5a3a;
  }

  /* Green Scrollbar Styling */
  ::-webkit-scrollbar {
    width: 6px;
    height: 6px;
  }

  ::-webkit-scrollbar-track {
    background: var(--scrollbar-track);
    border-radius: 10px;
  }

  ::-webkit-scrollbar-thumb {
    background: var(--scrollbar-thumb);
    border-radius: 10px;
  }

  ::-webkit-scrollbar-thumb:hover {
    background: var(--scrollbar-thumb-hover);
  }

  /* For Firefox */
  * {
    scrollbar-width: thin;
    scrollbar-color: var(--scrollbar-thumb) var(--scrollbar-track);
  }

  html, body {
    height: 100%;
    background: var(--bg);
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    overflow-x: hidden;
  }

  body {
    color: white;
    margin: 0;
    padding: 0;
    padding-bottom: 85px;
    min-height: 100vh;
    position: relative;
  }

  /* Minimal Mobile Header */
  .app-header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    background: var(--header-bg);
    color: white;
    z-index: 100;
    padding: 12px 16px;
    border-bottom: 2px solid var(--accent);
  }

  .header-content {
    display: flex;
    align-items: center;
    justify-content: space-between;
    max-width: 100%;
  }

  .logo-mini {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .logo-mini-circle {
    width: 36px;
    height: 36px;
    background: white;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .logo-mini-circle svg {
    width: 24px;
    height: 24px;
  }

  .logo-mini-text {
    font-size: 16px;
    font-weight: 600;
    color: white;
    line-height: 1.2;
  }

  .logo-mini-text small {
    font-size: 11px;
    color: var(--accent);
    display: block;
    font-weight: 400;
  }

  .page-title-badge {
    background: rgba(244, 180, 0, 0.15);
    padding: 6px 14px;
    border-radius: 30px;
    font-size: 13px;
    font-weight: 500;
    color: var(--accent);
    border: 1px solid rgba(244, 180, 0, 0.2);
    white-space: nowrap;
  }

  .user-header-mini {
    display: flex;
    align-items: center;
    gap: 12px;
    background: rgba(244, 180, 0, 0.15);
    padding: 5px 12px 5px 15px;
    border-radius: 40px;
    border: 1px solid var(--accent);
  }

  .user-header-mini .name {
    font-size: 13px;
    font-weight: 600;
    color: var(--accent);
    max-width: 100px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .logout-btn {
    background: #d32f2f;
    border: none;
    color: white;
    font-size: 12px;
    font-weight: 600;
    padding: 6px 14px;
    border-radius: 30px;
    display: flex;
    align-items: center;
    gap: 5px;
    cursor: pointer;
    min-height: 32px;
    box-shadow: 0 2px 8px rgba(211, 47, 47, 0.3);
  }

  .logout-btn svg {
    width: 14px;
    height: 14px;
    stroke: white;
  }

  .logout-btn:hover {
    background: #b71c1c;
  }

  .logout-btn:active {
    transform: scale(0.95);
  }

  .container {
    max-width: 100%;
    margin: 0 auto;
    padding: 75px 16px 20px;
    position: relative;
    height: auto;
    min-height: calc(100vh - 160px);
    overflow-y: auto;
    overflow-x: hidden;
  }

  /* Page visibility */
  .page {
    display: none !important;
  }
  
  .page.active {
    display: block !important;
  }

  /* Mobile Cards */
  .card {
    background: var(--card-bg);
    color: var(--card-text);
    border-radius: 20px;
    padding: 20px;
    margin-top: 16px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    border: 1px solid rgba(0,0,0,0.03);
  }

  h2 { 
    font-size: 1.35rem; 
    margin: 0 0 12px; 
    color: var(--card-text);
    font-weight: 600;
    border-left: 4px solid var(--accent);
    padding-left: 12px;
  }

  h3 {
    color: #0f3b2c;
    margin: 12px 0 8px;
    font-size: 1.1rem;
  }

  /* Auto-rotating Teachings Carousel */
  .teachings-carousel {
    position: relative;
    width: 100%;
    min-height: 320px;
    margin: 10px 0;
  }

  .teaching-slide {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.5s ease, visibility 0.5s ease;
    background: linear-gradient(135deg, #f8f9fa, #ffffff);
    border-radius: 18px;
    padding: 20px;
    border: 1px solid rgba(244, 180, 0, 0.2);
    box-shadow: 0 8px 20px rgba(0,0,0,0.05);
  }

  .teaching-slide.active-slide {
    opacity: 1;
    visibility: visible;
    position: relative;
  }

  .teaching-slide h3 {
    display: flex;
    align-items: center;
    gap: 8px;
    color: #0f3b2c;
    border-bottom: 2px solid var(--accent);
    padding-bottom: 10px;
    margin-bottom: 15px;
  }

  .teaching-slide h3 svg {
    width: 24px;
    height: 24px;
    stroke: var(--accent);
  }

  .teaching-content {
    font-size: 15px;
    line-height: 1.6;
    color: #333;
  }

  .hadith-text {
    background: #f5f5f5;
    padding: 15px;
    border-radius: 12px;
    border-left: 4px solid var(--accent);
    font-style: italic;
    margin: 10px 0;
  }

  .reference {
    font-size: 13px;
    color: #666;
    margin-top: 10px;
    text-align: right;
  }

  .slide-indicators {
    display: flex;
    justify-content: center;
    gap: 8px;
    margin-top: 20px;
  }

  .indicator {
    width: 8px;
    height: 8px;
    border-radius: 4px;
    background: #ddd;
    transition: all 0.3s;
    cursor: pointer;
  }

  .indicator.active {
    width: 24px;
    background: var(--accent);
  }

  .slide-timer {
    width: 100%;
    height: 3px;
    background: #eee;
    border-radius: 3px;
    margin-top: 15px;
    overflow: hidden;
  }

  .timer-bar {
    height: 100%;
    background: var(--accent);
    width: 0%;
    transition: width 0.1s linear;
  }

  /* Mobile Form Elements */
  input, select, textarea {
    font-size: 16px !important;
    padding: 14px;
    width: 100%;
    border-radius: 14px;
    border: 1.5px solid #e0e0e0;
    background: white;
  }

  /* Better touch targets */
  button {
    min-height: 48px;
    padding: 12px 20px;
    font-size: 16px;
    font-weight: 600;
    border-radius: 50px;
    background: var(--accent);
    color: #0f3b2c;
    border: none;
    touch-action: manipulation;
    cursor: pointer;
  }

  /* Mobile Bottom Navigation */
  .bottom-nav {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: white;
    display: flex;
    justify-content: space-around;
    align-items: center;
    padding: 8px 4px 12px;
    box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
    z-index: 99;
    border-top: 2px solid var(--accent);
    border-radius: 25px 25px 0 0;
  }

  .nav-btn {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 4px;
    background: transparent;
    color: #666;
    border: none;
    min-height: unset;
    padding: 8px 4px;
    font-size: 11px;
    font-weight: 500;
    transition: all 0.2s;
    border-radius: 20px;
  }

  .nav-btn svg {
    width: 22px;
    height: 22px;
    fill: none;
    stroke: currentColor;
    stroke-width: 2;
    margin-bottom: 2px;
  }

  .nav-btn.active {
    color: var(--accent);
    background: rgba(244, 180, 0, 0.1);
  }

  .nav-btn .label {
    font-size: 11px;
    font-weight: 500;
  }

  /* Login Card */
  .login-card {
    background: white;
    width: 100%;
    border-radius: 24px;
    padding: 30px 20px;
    text-align: center;
    margin: 10px auto;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
  }

  .logo-placeholder {
    width: 70px;
    height: 70px;
    margin: 0 auto 15px;
  }

  .logo-placeholder svg {
    width: 100%;
    height: 100%;
  }

  h1.mka-title {
    font-size: 22px;
    margin-bottom: 4px;
  }

  .subtitle {
    font-size: 12px;
    color: #666;
    margin-bottom: 25px;
  }

  .form-group {
    margin-bottom: 16px;
    text-align: left;
  }

  .form-group label {
    font-size: 13px;
    margin-bottom: 5px;
    display: block;
    color: #333;
  }

  .btn-primary {
    width: 100%;
    padding: 16px;
    font-size: 16px;
    background: var(--bg);
    color: white;
  }

  .btn-qr {
    width: 100%;
    padding: 14px;
    border: 2px solid var(--bg);
    background: white;
    color: var(--bg);
  }

  /* Detailed Calculator Styles */
  .calculator-detail {
    background: linear-gradient(135deg, #f8f9fa, #ffffff);
    border-radius: 18px;
    padding: 20px;
    margin-bottom: 15px;
  }

  .asset-input-group {
    background: white;
    border-radius: 14px;
    padding: 15px;
    margin-bottom: 12px;
    border: 1px solid #e0e0e0;
  }

  .asset-label {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
    color: #0f3b2c;
    font-weight: 600;
  }

  .asset-label svg {
    width: 20px;
    height: 20px;
    stroke: var(--accent);
  }

  .input-hint {
    font-size: 12px;
    color: #666;
    margin-top: 4px;
  }

  .nisab-breakdown {
    background: #e8f5e9;
    border-radius: 16px;
    padding: 15px;
    margin: 20px 0;
  }

  .nisab-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px dashed rgba(15, 59, 44, 0.2);
  }

  .nisab-item:last-child {
    border-bottom: none;
  }

  .nisab-item .label {
    color: #2e7d32;
    font-weight: 500;
  }

  .nisab-item .value {
    font-weight: 600;
    color: #0f3b2c;
  }

  .calculation-steps {
    background: #fff3e0;
    border-radius: 16px;
    padding: 15px;
    margin: 15px 0;
    font-size: 14px;
  }

  .step {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 5px 0;
  }

  .step-number {
    width: 22px;
    height: 22px;
    background: var(--accent);
    color: #0f3b2c;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: 600;
  }

  .result-box {
    background: linear-gradient(135deg, #0f3b2c, #1a5a3a);
    color: white;
    padding: 20px;
    border-radius: 20px;
    text-align: center;
    margin-top: 20px;
  }

  .result-box .label {
    font-size: 14px;
    opacity: 0.9;
    margin-bottom: 5px;
  }

  .result-box .amount {
    font-size: 36px;
    font-weight: 700;
    color: var(--accent);
    margin: 5px 0;
  }

  .result-box .detail {
    font-size: 12px;
    opacity: 0.8;
  }

  /* Green Sliders */
  .slider {
    width: 100%;
    height: 40px;
    -webkit-appearance: none;
    background: transparent;
  }

  .slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 24px;
    height: 24px;
    background: #0f3b2c; /* Dark green thumb */
    border-radius: 50%;
    margin-top: -9px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    border: 2px solid var(--accent); /* Gold border for contrast */
    cursor: pointer;
  }

  .slider::-webkit-slider-thumb:hover {
    background: #1a5a3a;
    transform: scale(1.1);
  }

  .slider::-webkit-slider-runnable-track {
    height: 8px;
    background: linear-gradient(to right, #0f3b2c, #2e7d32); /* Green gradient track */
    border-radius: 4px;
    border: none;
  }

  /* For Firefox */
  .slider::-moz-range-thumb {
    width: 24px;
    height: 24px;
    background: #0f3b2c;
    border-radius: 50%;
    border: 2px solid var(--accent);
    cursor: pointer;
  }

  .slider::-moz-range-track {
    height: 8px;
    background: linear-gradient(to right, #0f3b2c, #2e7d32);
    border-radius: 4px;
  }

  .slider::-moz-range-progress {
    height: 8px;
    background: var(--accent);
    border-radius: 4px;
  }

  /* Fund items */
  .fund {
    padding: 15px 0;
    border-bottom: 1px solid #eee;
  }

  .fund:last-child {
    border-bottom: none;
  }

  .percent-display {
    font-size: 1.2rem;
    color: var(--accent);
    font-weight: 600;
  }

  /* History list */
  .history-list {
    list-style: none;
  }
  
  .history-list li {
    font-size: 14px;
    padding: 12px 0;
    border-bottom: 1px solid #eee;
  }
  
  .history-list li:last-child {
    border-bottom: none;
  }

  /* Hidden class */
  .hidden { 
    display: none !important; 
  }

  /* Status messages */
  #loginStatus, #payStatus {
    font-size: 14px;
    padding: 10px;
    text-align: center;
    margin-top: 10px;
  }

  /* Ensure no horizontal scroll */
  body, html {
    overflow-x: hidden;
    width: 100%;
  }

  /* Container scroll with green bar */
  .container {
    scrollbar-width: thin;
    scrollbar-color: var(--scrollbar-thumb) var(--scrollbar-track);
  }

  .container::-webkit-scrollbar {
    width: 6px;
  }

  .container::-webkit-scrollbar-track {
    background: var(--scrollbar-track);
  }

  .container::-webkit-scrollbar-thumb {
    background: var(--scrollbar-thumb);
    border-radius: 10px;
  }

  .container::-webkit-scrollbar-thumb:hover {
    background: var(--scrollbar-thumb-hover);
  }

  /* User info section when logged out - hide completely */
  .user-header-mini[style*="display: none"] {
    display: none !important;
  }
</style>
</head>
<body>
  <!-- Minimal Mobile Header -->
  <header class="app-header">
    <div class="header-content">
      <div class="logo-mini">
        <div class="logo-mini-circle">
          <svg viewBox="0 0 24 24" fill="none">
            <path d="M12 2C8 6 4 8 4 12c0 4 4 8 8 10 4-2 8-6 8-10 0-4-4-6-8-10z" fill="#0f3b2c"/>
          </svg>
        </div>
        <div class="logo-mini-text">
          MKA Uganda <small>Zakat</small>
        </div>
      </div>

      <span class="page-title-badge" id="currentPageTitle">Home</span>

      <!-- User info with prominent logout button -->
      <div class="user-header-mini" id="userInfoSection" style="display: none;">
        <span class="name" id="headerUserName">Member</span>
        <button class="logout-btn" id="logoutBtn">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
            <polyline points="16 17 21 12 16 7"></polyline>
            <line x1="21" y1="12" x2="9" y2="12"></line>
          </svg>
          Exit
        </button>
      </div>
    </div>
  </header>

  <main class="container">

    <!-- LOGIN PAGE -->
    <div id="loginPage" class="page active">
      <div class="login-card">
        <div class="logo-placeholder">
          <svg viewBox="0 0 64 64">
            <defs>
              <linearGradient id="ugandaFlag" y1="0" y2="1">
                <stop offset="0" stop-color="#000"/>
                <stop offset="0.333" stop-color="#000"/>
                <stop offset="0.333" stop-color="#FFD700"/>
                <stop offset="0.666" stop-color="#FFD700"/>
                <stop offset="0.666" stop-color="#FF0000"/>
                <stop offset="1" stop-color="#FF0000"/>
              </linearGradient>
            </defs>
            <circle cx="32" cy="32" r="32" fill="url(#ugandaFlag)" />
            <path d="M32 14 L36 32 L28 32 Z" fill="white" />
          </svg>
        </div>
        <h1 class="mka-title">MKA - UGANDA</h1>
        <p class="subtitle">AHMADIYYA MUSLIM COMMUNITY</p>

        <div class="form-group">
          <label>Full Name</label>
          <input id="loginName" type="text" placeholder="Ahmed Ibrahim" />
        </div>

        <div class="form-group">
          <label>ID Number</label>
          <input id="loginId" type="password" placeholder="Enter your ID" />
        </div>

        <button id="loginBtn" class="btn-primary">Secure Login</button>

        <div style="margin: 20px 0; color: #999; font-size: 12px;">OR</div>

        <button class="btn-qr" onclick="document.getElementById('qrReader').scrollIntoView({behavior: 'smooth'})">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <rect x="7" y="7" width="10" height="10" rx="1"></rect>
          </svg>
          Scan Member Card
        </button>

        <div id="qrReader" style="margin-top: 15px;"></div>
        <div id="loginStatus"></div>

        <div class="footer" style="margin-top: 25px; font-size: 11px;">
          ¬© 2025 Majlis Khuddamul Ahmadiyya Uganda
        </div>
      </div>
    </div>

    <!-- HOME PAGE with Auto-rotating Teachings -->
    <div id="homePage" class="page">
      <div class="card">
        <h2>üè† Zakat Teachings</h2>
        <p style="margin-bottom: 15px;">Assalamu Alaikum! Learn about the beauty of Zakat.</p>
        
        <div class="teachings-carousel" id="teachingsCarousel">
          <!-- Teaching slides will be injected by JavaScript -->
        </div>
        
        <div class="slide-indicators" id="slideIndicators"></div>
        <div class="slide-timer">
          <div class="timer-bar" id="timerBar"></div>
        </div>
      </div>
    </div>

    <!-- CALCULATOR PAGE with Detailed Nisab -->
    <div id="calcPage" class="page">
      <div class="card">
        <h2>üßÆ Zakat Calculator</h2>
        <p>Calculate your Zakat with detailed breakdown</p>
        
        <!-- Nisab Breakdown -->
        <div class="nisab-breakdown">
          <h3 style="margin-top: 0; font-size: 16px;">üìä Current Nisab Values</h3>
          <div class="nisab-item">
            <span class="label">Gold Nisab (87.48g)</span>
            <span class="value" id="goldNisabValue">UGX 7,435,800</span>
          </div>
          <div class="nisab-item">
            <span class="label">Silver Nisab (612.36g)</span>
            <span class="value" id="silverNisabValue">UGX 3,367,980</span>
          </div>
          <div class="nisab-item">
            <span class="label">‚úÖ Applicable Nisab (Lower)</span>
            <span class="value" style="color: var(--accent);" id="applicableNisab">UGX 3,367,980</span>
          </div>
        </div>

        <!-- Asset Inputs -->
        <div class="asset-input-group">
          <div class="asset-label">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="2" y="6" width="20" height="12" rx="2"></rect>
              <circle cx="12" cy="12" r="2"></circle>
            </svg>
            Cash & Bank Balance
          </div>
          <input type="number" id="cashAmount" placeholder="Enter amount (UGX)" min="0" value="0" step="1000">
          <div class="input-hint">Includes savings, current accounts, and cash in hand</div>
        </div>

        <div class="asset-input-group">
          <div class="asset-label">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <path d="M12 6v6l4 2"></path>
            </svg>
            Gold (grams)
          </div>
          <input type="number" id="goldAmount" placeholder="Enter weight in grams" min="0" value="0" step="0.1">
          <div class="input-hint">1 tola = 11.664 grams | Current price: UGX 85,000/g</div>
        </div>

        <div class="asset-input-group">
          <div class="asset-label">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <path d="M12 6v6l4 2"></path>
            </svg>
            Silver (grams)
          </div>
          <input type="number" id="silverAmount" placeholder="Enter weight in grams" min="0" value="0" step="0.1">
          <div class="input-hint">1 tola = 11.664 grams | Current price: UGX 5,500/g</div>
        </div>

        <div class="asset-input-group">
          <div class="asset-label">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="2" y="7" width="20" height="14" rx="2"></rect>
              <path d="M16 3L20 7 16 11"></path>
            </svg>
            Business Inventory
          </div>
          <input type="number" id="inventoryAmount" placeholder="Enter value (UGX)" min="0" value="0" step="1000">
          <div class="input-hint">Stock in trade, goods for sale</div>
        </div>

        <!-- Calculation Steps -->
        <div class="calculation-steps" id="calculationSteps">
          <div class="step">
            <span class="step-number">1</span>
            <span>Total Wealth = Cash + Gold + Silver + Inventory</span>
          </div>
          <div class="step">
            <span class="step-number">2</span>
            <span>Compare with Nisab (lower of gold/silver value)</span>
          </div>
          <div class="step">
            <span class="step-number">3</span>
            <span>If wealth ‚â• Nisab, Zakat = 2.5% of total wealth</span>
          </div>
        </div>

        <!-- Result Box -->
        <div class="result-box">
          <div class="label">Your Zakat Due</div>
          <div class="amount" id="zakatResult">UGX 0</div>
          <div class="detail" id="zakatDetail">Total Wealth: UGX 0</div>
          <div class="detail" id="zakatStatus"></div>
          <button id="applyToPayBtn" style="width: 100%; margin-top: 15px; background: white; color: #0f3b2c;">Apply to Payment</button>
        </div>
      </div>
    </div>

    <!-- PAY ZAKAT PAGE -->
    <div id="payPage" class="page">
      <div class="card">
        <h2>üí≥ Pay Zakat</h2>
        
        <div style="margin-bottom: 15px;">
          <label style="display: block; margin-bottom: 8px;">Total Amount (UGX)</label>
          <input id="totalAmount" type="number" min="0" step="1000" value="0" />
        </div>

        <div id="fundsContainer">Loading funds...</div>

        <button id="payNowBtn" class="pay-now" style="width: 100%; margin: 15px 0;" disabled>üí≥ Pay Now</button>
        <button id="confirmPayBtn" class="confirm-btn" style="width: 100%;" disabled>‚úÖ Save Allocation</button>
        <div id="payStatus"></div>
      </div>
    </div>

    <!-- HISTORY PAGE -->
    <div id="historyPage" class="page">
      <div class="card">
        <h2>üìú Payment History</h2>
        <div id="historyContainer">Loading history...</div>
      </div>
    </div>
  </main>

  <!-- Bottom Navigation - Icons + Text -->
  <nav id="bottomNav" class="bottom-nav">
    <button id="navHome" class="nav-btn">
      <svg viewBox="0 0 24 24">
        <path d="M3 10.5L12 4l9 6.5V20a1 1 0 0 1-1 1h-5v-6H9v6H4a1 1 0 0 1-1-1V10.5z"/>
      </svg>
      <span class="label">Home</span>
    </button>

    <button id="navCalc" class="nav-btn">
      <svg viewBox="0 0 24 24">
        <rect x="6" y="3" width="12" height="18" rx="2"/>
        <path d="M9 7h6M9 11h6M9 15h4"/>
      </svg>
      <span class="label">Calc</span>
    </button>

    <button id="navPay" class="nav-btn">
      <svg viewBox="0 0 24 24">
        <path d="M21 12v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-6"/>
        <path d="M7 10V6a5 5 0 0 1 10 0v4"/>
      </svg>
      <span class="label">Pay</span>
    </button>

    <button id="navHistory" class="nav-btn">
      <svg viewBox="0 0 24 24">
        <circle cx="12" cy="12" r="10"/>
        <polyline points="12 6 12 12 16 14"/>
      </svg>
      <span class="label">History</span>
    </button>
  </nav>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>

  <script>
  const SUPABASE_URL = "https://pqrsljahrnjgkadflbmr.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBxcnNsamFocm5qZ2thZGZsYm1yIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA1NTg0NTYsImV4cCI6MjA4NjEzNDQ1Nn0.egED0C2iRp6j3Xp4ldgrdI0GBep2J7VUR52rBbzsVdo";
  const { createClient } = window.supabase;
  const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  let funds = [];
  let percentages = {};
  let currentMemberId = localStorage.getItem("currentMemberId") || null;
  let currentUserUuid = localStorage.getItem("currentUserUuid") || null;
  let currentUserEmail = localStorage.getItem("currentUserEmail") || null;
  let currentUserName = localStorage.getItem("currentUserName") || null;
  let qrScannerInstance = null;
  
  // Auto-rotating teachings variables
  let currentSlide = 0;
  let slideInterval;
  let timerInterval;
  let timerProgress = 0;
  const SLIDE_DURATION = 8000; // 8 seconds per slide

  // Rich teaching content - never repeats
  const teachings = [
    {
      icon: 'üìñ',
      title: 'Hadith on Zakat',
      content: '<div class="hadith-text">"Whoever gives charity equal to a date from good earnings ‚Äì and Allah accepts only what is good ‚Äì Allah takes it in His right hand and nurtures it for its owner as one of you nurtures his foal, until it becomes like a mountain."</div>',
      reference: 'Sahih Bukhari & Sahih Muslim'
    },
    {
      icon: 'üéôÔ∏è',
      title: 'Huzur (aba) on Zakat',
      content: '<p>"Zakat is not just a financial obligation; it is a spiritual purification. When you pay Zakat with sincerity, it cleanses your wealth and your soul. It establishes economic justice in society and strengthens the bonds of brotherhood."</p>',
      reference: 'Hazrat Mirza Masroor Ahmad (aba) - Friday Sermon'
    },
    {
      icon: '‚ú®',
      title: 'Quranic Promise',
      content: '<p>Allah says in the Holy Quran:</p><div class="hadith-text">"The example of those who spend their wealth in the way of Allah is like a seed of grain which grows seven spikes; in each spike is a hundred grains. And Allah multiplies His reward for whom He wills."</div>',
      reference: 'Surah Al-Baqarah (2:261)'
    },
    {
      icon: 'ü§≤',
      title: 'Benefits of Zakat',
      content: '<ul style="margin-left: 20px;"><li>Purifies wealth and soul</li><li>Increases blessings in wealth</li><li>Protects from calamities</li><li>Helps the needy in community</li><li>Brings Allah\'s pleasure</li><li>Opens doors of mercy</li></ul>',
      reference: 'Teachings of Islam'
    },
    {
      icon: 'üìú',
      title: 'Who Deserves Zakat',
      content: '<p>The Quran specifies eight categories:</p><ul style="margin-left: 20px;"><li>The poor (Fuqara)</li><li>The needy (Masakin)</li><li>Zakat collectors</li><li>Those whose hearts are to be reconciled</li><li>Freeing captives</li><li>Those in debt</li><li>In the way of Allah</li><li>The wayfarer</li></ul>',
      reference: 'Surah At-Tawbah (9:60)'
    },
    {
      icon: 'üíé',
      title: 'Wisdom of Zakat',
      content: '<p>Hazrat Mirza Ghulam Ahmad (as) said:</p><div class="hadith-text">"Zakat is a means of developing sympathy and compassion for the poor. It removes arrogance from the heart and creates humility. It reminds us that all wealth belongs to Allah."</div>',
      reference: 'Malfuzat - Volume 5'
    },
    {
      icon: '‚≠ê',
      title: 'Reward Multiplied',
      content: '<p>The Prophet Muhammad (Ô∑∫) said:</p><div class="hadith-text">"Charity does not decrease wealth. No one forgives another except that Allah increases his honor. And no one humbles himself for the sake of Allah except that Allah raises his status."</div>',
      reference: 'Sahih Muslim'
    },
    {
      icon: 'üåô',
      title: 'Zakat in Ramadan',
      content: '<p>Ibn Abbas (ra) reported: The Messenger of Allah (Ô∑∫) was the most generous of people, and he was even more generous during Ramadan when he met with Jibril. He would give charity more freely than the blowing wind.</p>',
      reference: 'Sahih Bukhari'
    }
  ];

  // Initialize teachings carousel
  function initTeachingsCarousel() {
    const carousel = document.getElementById('teachingsCarousel');
    const indicators = document.getElementById('slideIndicators');
    
    if (!carousel) return;
    
    // Build slides
    let slidesHtml = '';
    teachings.forEach((teaching, index) => {
      slidesHtml += `
        <div class="teaching-slide ${index === 0 ? 'active-slide' : ''}" data-slide="${index}">
          <h3>
            <span>${teaching.icon}</span>
            ${teaching.title}
          </h3>
          <div class="teaching-content">
            ${teaching.content}
          </div>
          <div class="reference">‚Äî ${teaching.reference}</div>
        </div>
      `;
    });
    carousel.innerHTML = slidesHtml;
    
    // Build indicators
    let indicatorsHtml = '';
    teachings.forEach((_, index) => {
      indicatorsHtml += `<div class="indicator ${index === 0 ? 'active' : ''}" onclick="goToSlide(${index})"></div>`;
    });
    indicators.innerHTML = indicatorsHtml;
    
    // Start auto-rotation
    startSlideRotation();
  }

  function startSlideRotation() {
    if (slideInterval) clearInterval(slideInterval);
    if (timerInterval) clearInterval(timerInterval);
    
    timerProgress = 0;
    updateTimerBar();
    
    slideInterval = setInterval(() => {
      nextSlide();
    }, SLIDE_DURATION);
    
    timerInterval = setInterval(() => {
      timerProgress = (timerProgress + 100) % SLIDE_DURATION;
      updateTimerBar();
    }, 100);
  }

  function updateTimerBar() {
    const timerBar = document.getElementById('timerBar');
    if (timerBar) {
      const progress = (timerProgress / SLIDE_DURATION) * 100;
      timerBar.style.width = `${progress}%`;
    }
  }

  window.goToSlide = function(index) {
    // Update slides
    document.querySelectorAll('.teaching-slide').forEach(slide => {
      slide.classList.remove('active-slide');
    });
    document.querySelector(`.teaching-slide[data-slide="${index}"]`).classList.add('active-slide');
    
    // Update indicators
    document.querySelectorAll('.indicator').forEach((ind, i) => {
      if (i === index) {
        ind.classList.add('active');
      } else {
        ind.classList.remove('active');
      }
    });
    
    currentSlide = index;
    
    // Reset timer
    timerProgress = 0;
    updateTimerBar();
  };

  function nextSlide() {
    currentSlide = (currentSlide + 1) % teachings.length;
    goToSlide(currentSlide);
  }

  // Navigation
  function showPage(pageId){
    document.querySelectorAll('.page').forEach(p => {
      p.classList.remove('active');
    });
    
    const page = document.getElementById(pageId);
    if(page) {
      page.classList.add('active');
    }

    const pageTitles = {
      'homePage': 'Home',
      'calcPage': 'Calculator',
      'payPage': 'Pay',
      'historyPage': 'History',
      'loginPage': 'Login'
    };
    document.getElementById('currentPageTitle').textContent = pageTitles[pageId] || 'Home';

    const userInfoSection = document.getElementById('userInfoSection');
    if(pageId === 'loginPage' || !currentMemberId) {
      userInfoSection.style.display = 'none';
    } else {
      userInfoSection.style.display = 'flex';
      document.getElementById('headerUserName').textContent = currentUserName || 'Member';
    }

    const bottomNav = document.getElementById("bottomNav");
    if(pageId === "loginPage"){
      bottomNav.classList.add("hidden");
      stopQrScanner();
      startQrScanner();
    } else {
      bottomNav.classList.remove("hidden");
      stopQrScanner();
    }

    document.querySelectorAll('.bottom-nav .nav-btn').forEach(b => b.classList.remove('active'));
    switch(pageId){
      case 'homePage': 
        document.getElementById('navHome').classList.add('active');
        initTeachingsCarousel(); // Initialize carousel when home page is shown
        break;
      case 'calcPage': document.getElementById('navCalc').classList.add('active'); break;
      case 'payPage': document.getElementById('navPay').classList.add('active'); fetchFunds(); break;
      case 'historyPage': document.getElementById('navHistory').classList.add('active'); fetchHistory(); break;
    }
  }

  // Event Listeners
  document.getElementById("navHome").addEventListener("click", ()=> showPage("homePage"));
  document.getElementById("navCalc").addEventListener("click", ()=> showPage("calcPage"));
  document.getElementById("navPay").addEventListener("click", ()=> showPage("payPage"));
  document.getElementById("navHistory").addEventListener("click", ()=> showPage("historyPage"));

  // Logout - using the new prominent button
  document.getElementById("logoutBtn").addEventListener("click", ()=>{
    localStorage.clear();
    currentMemberId = null;
    currentUserUuid = null;
    currentUserEmail = null;
    currentUserName = null;
    showPage("loginPage");
  });

  // Login
  async function loginUser(name, idNumber){
    document.getElementById("loginStatus").innerText = "Checking...";
    try {
      const { data, error } = await supabaseClient
        .from("members")
        .select("member_id, user_id, full_name, email")
        .eq("full_name", name)
        .eq("member_id", idNumber)
        .single();

      if(error || !data){
        document.getElementById("loginStatus").innerText = "‚ùå Invalid credentials.";
        return;
      }

      currentMemberId = data.member_id;
      currentUserUuid = data.user_id || null;
      currentUserName = data.full_name;
      currentUserEmail = data.email || `${name.toLowerCase().replace(' ', '.')}@mkau.org`;

      localStorage.setItem("currentMemberId", currentMemberId);
      localStorage.setItem("currentUserUuid", currentUserUuid);
      localStorage.setItem("currentUserName", currentUserName);
      localStorage.setItem("currentUserEmail", currentUserEmail);

      document.getElementById("loginStatus").innerText = "‚úÖ Welcome " + data.full_name;
      showPage("homePage");
    } catch(e){
      document.getElementById("loginStatus").innerText = "‚ùå Login error.";
    }
  }

  document.getElementById("loginBtn").addEventListener("click", ()=>{
    const name = document.getElementById("loginName").value.trim();
    const idNumber = document.getElementById("loginId").value.trim();
    if(!name || !idNumber){
      document.getElementById("loginStatus").innerText = "Enter name and ID.";
      return;
    }
    loginUser(name, idNumber);
  });

  // QR Scanner
  function startQrScanner(){
    const qrReaderEl = document.getElementById("qrReader");
    if(!qrReaderEl || qrScannerInstance) return;
    qrScannerInstance = new Html5Qrcode("qrReader");
    qrScannerInstance.start(
      { facingMode: "environment" },
      { fps: 5, qrbox: 200 },
      qrMessage => {
        document.getElementById("loginId").value = qrMessage;
        document.getElementById("loginStatus").innerText = "QR scanned!";
      },
      error => {}
    ).catch(() => {
      qrReaderEl.innerHTML = "<div style='font-size:12px;'>Camera unavailable</div>";
      qrScannerInstance = null;
    });
  }

  function stopQrScanner(){
    if(!qrScannerInstance) return;
    qrScannerInstance.stop().then(() => {
      qrScannerInstance.clear();
      qrScannerInstance = null;
    }).catch(()=>{});
  }

  // Detailed Calculator with Nisab breakdown
  let goldPricePerGram = 85000;
  let silverPricePerGram = 5500;
  const GOLD_NISAB_GRAMS = 87.48;
  const SILVER_NISAB_GRAMS = 612.36;

  function updateNisabDisplay() {
    const goldNisab = goldPricePerGram * GOLD_NISAB_GRAMS;
    const silverNisab = silverPricePerGram * SILVER_NISAB_GRAMS;
    const applicableNisab = Math.min(goldNisab, silverNisab);
    
    document.getElementById('goldNisabValue').textContent = `UGX ${Math.round(goldNisab).toLocaleString()}`;
    document.getElementById('silverNisabValue').textContent = `UGX ${Math.round(silverNisab).toLocaleString()}`;
    document.getElementById('applicableNisab').textContent = `UGX ${Math.round(applicableNisab).toLocaleString()}`;
    
    return applicableNisab;
  }

  function calculateZakat() {
    const cash = parseFloat(document.getElementById('cashAmount').value) || 0;
    const gold = parseFloat(document.getElementById('goldAmount').value) || 0;
    const silver = parseFloat(document.getElementById('silverAmount').value) || 0;
    const inventory = parseFloat(document.getElementById('inventoryAmount').value) || 0;

    const goldValue = gold * goldPricePerGram;
    const silverValue = silver * silverPricePerGram;
    const totalWealth = cash + goldValue + silverValue + inventory;
    
    const nisab = updateNisabDisplay();
    
    let zakatDue = 0;
    let status = '';
    
    if (totalWealth >= nisab) {
      zakatDue = totalWealth * 0.025;
      status = `‚úÖ Eligible for Zakat`;
    } else {
      status = `‚ö†Ô∏è Below Nisab threshold`;
    }
    
    document.getElementById('zakatResult').textContent = `UGX ${Math.round(zakatDue).toLocaleString()}`;
    document.getElementById('zakatDetail').textContent = `Total Wealth: UGX ${Math.round(totalWealth).toLocaleString()}`;
    document.getElementById('zakatStatus').textContent = status;
    
    return Math.round(zakatDue);
  }

  ['cashAmount', 'goldAmount', 'silverAmount', 'inventoryAmount'].forEach(id => {
    document.getElementById(id).addEventListener('input', calculateZakat);
  });

  document.getElementById('applyToPayBtn').addEventListener('click', ()=>{
    const zakatAmount = calculateZakat();
    if (zakatAmount > 0) {
      document.getElementById('totalAmount').value = zakatAmount;
      showPage('payPage');
      updateTotals();
    } else {
      alert('No Zakat due. Your wealth is below Nisab.');
    }
  });

  // Initialize calculator
  calculateZakat();

  // Funds and allocations
  async function fetchFunds(){
    const container = document.getElementById("fundsContainer");
    container.innerHTML = "Loading funds...";
    try {
      const { data, error } = await supabaseClient
        .from("zakat_funds")
        .select("*")
        .order("display_order", { ascending: true });

      if(error) throw error;
      funds = data || [];
      renderFunds();
    } catch(e){
      container.innerHTML = "Error loading funds.";
    }
  }

  function renderFunds(){
    const container = document.getElementById("fundsContainer");
    if(!funds.length){
      container.innerHTML = "<div class='card'>No funds found.</div>";
      return;
    }
    percentages = {};
    let html = "";
    funds.forEach(fund => {
      percentages[fund.id] = 0;
      html += `
        <div class="fund">
          <strong>${escapeHtml(fund.name)}</strong><br/><br/>
          <input type="range" min="0" max="100" value="0" class="slider" id="slider-${fund.id}" oninput="handleSlider(${fund.id}, this.value)" />
          <div style="margin-top:8px; display: flex; justify-content: space-between;">
            <span class="percent-display" id="percent-${fund.id}">0%</span>
            <span>UGX <span id="amount-${fund.id}">0</span></span>
          </div>
        </div>
      `;
    });
    container.innerHTML = html;
    updateTotals();
  }

  window.handleSlider = function(id, value){
    value = parseInt(value) || 0;
    percentages[id] = value;
    let total = Object.values(percentages).reduce((a,b)=>a+(b||0),0);
    
    if(total > 100){
      percentages[id] -= (total - 100);
      document.getElementById(`slider-${id}`).value = percentages[id];
    }
    
    Object.keys(percentages).forEach(key => {
      const p = document.getElementById(`percent-${key}`);
      if(p) p.innerText = percentages[key] + "%";
    });
    
    updateTotals();
  };

  function updateTotals(){
    const totalAmount = parseFloat(document.getElementById("totalAmount").value) || 0;
    const totalPercent = Object.values(percentages).reduce((a,b)=>a+(b||0),0);

    funds.forEach(fund => {
      const percent = percentages[fund.id] || 0;
      const amount = Math.round(totalAmount * percent / 100);
      const el = document.getElementById(`amount-${fund.id}`);
      if(el) el.innerText = amount.toLocaleString();
    });

    const status = document.getElementById("totalStatus");
    const confirmBtn = document.getElementById("confirmPayBtn");
    const payNowBtn = document.getElementById("payNowBtn");

    if(status) {
      if(totalPercent === 100 && totalAmount > 0){
        status.innerHTML = `‚úÖ Total: ${totalPercent}%`;
        status.className = "total-bar success";
        if(confirmBtn) confirmBtn.disabled = false;
        if(payNowBtn) payNowBtn.disabled = false;
      } else {
        status.innerHTML = `‚ö†Ô∏è Total: ${totalPercent}% (must be 100%)`;
        status.className = "total-bar warning";
        if(confirmBtn) confirmBtn.disabled = true;
        if(payNowBtn) payNowBtn.disabled = true;
      }
    }
  }

  document.getElementById("totalAmount")?.addEventListener("input", updateTotals);

  // Payment
  document.getElementById("payNowBtn")?.addEventListener("click", async ()=>{
    if(!currentMemberId){
      document.getElementById("payStatus").innerText = "‚ùå Login required.";
      return;
    }
    document.getElementById("payStatus").innerText = "Processing...";
    setTimeout(async () => {
      await saveAllocationsAfterPayment();
    }, 1000);
  });

  async function saveAllocationsAfterPayment(){
    const totalAmount = parseFloat(document.getElementById("totalAmount").value) || 0;
    const allocations = funds.map(fund => ({
      fund_id: fund.id,
      member_id: currentMemberId,
      user_id: currentUserUuid,
      percent: percentages[fund.id] || 0,
      amount: (totalAmount * (percentages[fund.id] || 0) / 100).toFixed(2),
      created_at: new Date().toISOString()
    })).filter(a => parseFloat(a.amount) > 0);

    try {
      const { error } = await supabaseClient
        .from("zakat_allocations")
        .insert(allocations);

      if(error) throw error;
      
      document.getElementById("payStatus").innerText = "‚úÖ Payment saved!";
      // Reset
      Object.keys(percentages).forEach(key => {
        percentages[key] = 0;
        const s = document.getElementById(`slider-${key}`);
        if(s) s.value = 0;
        const p = document.getElementById(`percent-${key}`);
        if(p) p.innerText = "0%";
      });
      document.getElementById("totalAmount").value = "0";
      updateTotals();
      fetchHistory();
    } catch(e){
      document.getElementById("payStatus").innerText = "‚ùå Error saving.";
    }
  }

  document.getElementById("confirmPayBtn")?.addEventListener("click", async ()=>{
    if(!currentMemberId){
      document.getElementById("payStatus").innerText = "‚ùå Login required.";
      return;
    }
    await saveAllocationsAfterPayment();
  });

  // History
  async function fetchHistory(){
    const container = document.getElementById("historyContainer");
    container.innerHTML = "Loading...";
    if(!currentMemberId){
      container.innerHTML = "‚ùå Login to view history.";
      return;
    }

    try {
      const { data, error } = await supabaseClient
        .from("zakat_allocations")
        .select("id, fund_id, percent, amount, created_at")
        .eq("member_id", currentMemberId)
        .order("created_at", { ascending: false })
        .limit(20);

      if(error) throw error;
      
      if(!data || !data.length){
        container.innerHTML = "No payments yet.";
        return;
      }

      let html = "<ul class='history-list'>";
      data.forEach(record => {
        const fund = funds.find(f => f.id === record.fund_id);
        const fundName = fund ? fund.name : "Fund";
        html += `
          <li>
            <strong>${fundName}</strong><br/>
            UGX ${Number(record.amount).toLocaleString()} | ${record.percent}%<br/>
            <small>${new Date(record.created_at).toLocaleDateString()}</small>
          </li>
        `;
      });
      html += "</ul>";
      container.innerHTML = html;
    } catch(e){
      container.innerHTML = "‚ùå Error loading history.";
    }
  }

  function escapeHtml(str){
    return String(str || '').replace(/[&<>"']/g, function(m){
      return {
        '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
      }[m];
    });
  }

  // Initialize
  window.addEventListener("load", ()=>{
    if(currentMemberId){
      showPage("homePage");
    } else {
      showPage("loginPage");
    }
    fetchFunds();
  });
  </script>
</body>
</html>